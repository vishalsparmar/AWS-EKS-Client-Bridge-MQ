#!/bin/bash
AZ="eu-west-2c"
echo "Simulating AZ failure for: $AZ"

# 1. Cordon all nodes in the AZ
echo "Cordoning nodes in $AZ..."
kubectl cordon $(kubectl get nodes -l topology.kubernetes.io/zone=$AZ -o name)

# 2. Drain all nodes in the AZ
echo "Draining nodes in $AZ..."
for node in $(kubectl get nodes -l topology.kubernetes.io/zone=$AZ -o name); do
  echo "Draining $node..."
  kubectl drain $node --ignore-daemonsets --delete-emptydir-data --grace-period=300 --timeout=600s
done

# 3. Verify no pods running in the AZ
echo "Verifying no pods in $AZ..."
kubectl get pods -A -o wide | grep $AZ

echo "AZ failure simulation complete for $AZ"



# Check nodes are schedulable again
kubectl get nodes -o custom-columns="NAME:.metadata.name,UNSCHEDULABLE:.spec.unschedulable"

# Should show "false" or "<none>" for all nodes
